machine:
  node:
    version: 8.9.3
  environment:
    UV_THREADPOOL_SIZE: 32

dependencies:
  pre:
    - rm node_modules/node-red-contrib-dynamorse-core
    - npm install tape
  post:
    - npm install -g tap-xunit
    - npm install -g node-red
    - npm install -g pm2
    - npm link
    - mkdir ~/.node-red
    - cd ~/.node-red; npm install node-red-contrib-dynamorse-core
    - cd ~/.node-red/node_modules/node-red-contrib-dynamorse-core; npm link
    - npm link node-red-contrib-dynamorse-core
    - cd ~/.node-red; npm link node-red-contrib-dynamorse-http-io
    - pm2 start /opt/circleci/nodejs/v8.9.3/bin/node-red
    - sleep 2 ; node ~/.node-red/node_modules/node-red-contrib-dynamorse-core/scripts/dynamorse-setup.js
      # curl -d '{"module": "node-red-contrib-dynamorse-http-io"}' -H 'Content-Type: application/json' 127.0.0.1:1880/nodes

test:
  override:
    - npm run lint
    - mkdir $CIRCLE_TEST_REPORTS/xunit
    - set -eo pipefail && npm test | tap-xunit > $CIRCLE_TEST_REPORTS/xunit/results.xml
